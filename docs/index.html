<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parallel Computing Leaderboard@uni.lu</title>
  <meta name="description" content="Parallel Computing Leaderboard@uni.lu" />

  <!-- NES.css + Pixel font -->
  <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <link rel="apple-touch-icon" href="https://nostalgic-css.github.io/NES.css/favicon.png" />
  <link rel="shortcut icon" type="image/png" href="https://nostalgic-css.github.io/NES.css/favicon.png" />
  <link rel="shortcut icon" sizes="196x196" href="https://nostalgic-css.github.io/NES.css/favicon.png" />
  <style>
    :root {
      --bg1: #0f1220;
      --bg2: #1a1f35;
      --panel: #151a2b;
      --accent: #00e5ff;
    }

    html {
      min-height: 100%;
    }

    body {
      min-height: 100%;
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(0, 229, 255, 0.15), transparent),
        radial-gradient(1000px 500px at 90% 10%, rgba(255, 255, 255, 0.05), transparent),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      color: #e6e6e6;
      font-family: 'Press Start 2P', cursive;
      letter-spacing: 0.5px;
    }

    .wrap {
      max-width: 1500px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      display: grid;
      grid-template-columns: 64px 1fr auto;
      gap: 16px;
      align-items: center;
      /* margin-bottom: 20px; */
    }

    .brand-title {
      line-height: 1.3;
      padding-left: 10px;
    }

    .brand-sub {
      font-size: 10px;
      opacity: 0.8;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .about {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    @media (max-width: 900px) {

      header {
        display: grid;
        grid-template-columns: 1fr;
        align-items: center;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr; /* 小屏幕时上下排列 */
      }

      .about {
        display: grid;
        grid-template-columns: 1fr;
      }
    }

    .nes-container.is-dark {
      background: var(--panel);
      margin: 20px;
    }

    .hero {
      margin-bottom: 16px;
    }

    .repo-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }

    .status-line {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .countdown-time {
      font-size: 20px;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border: 2px solid #fff;
      border-radius: 999px;
      font-size: 10px;
      background: rgba(255, 255, 255, 0.06);
    }

    .nes-table td,
    .nes-table th {
      font-size: 12px;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    footer {
      /* margin-top: 28px; */
      opacity: 0.85;
      font-size: 10px;
      text-align: center;
    }

    .blink {
      animation: blink 1.2s steps(1, end) infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ---------- Cute overrides + table fixes ---------- */
    :root {
      /* softer, cute-ish palette */
      --bg1: #2a2a6a;
      /* deep indigo */
      --bg2: #4a3f86;
      /* violet */
      --panel: #262357;
      /* dark violet-blue */
      --accent: #ffd1dc;
      /* pastel pink */
    }

    body {
      background:
        radial-gradient(1000px 500px at 85% 5%, rgba(171, 235, 255, .22), transparent),
        radial-gradient(1200px 600px at 15% -10%, rgba(255, 209, 220, .25), transparent),
        linear-gradient(180deg, var(--bg2), var(--bg1));
    }

    /* tiny pixel-dots layer for retro charm */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(#fff 1px, transparent 1.2px);
      background-size: 4px 4px;
      opacity: .05;
      mix-blend-mode: screen;
    }

    /* table layout fixes */
    .nes-table {
      table-layout: auto;
      width: 100%;
    }

    .nes-table th,
    .nes-table td {
      white-space: nowrap;
      vertical-align: middle;
    }

    .nes-table td.pokemon {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nes-table td,
    .nes-table th {
      font-size: 12px;
    }

    .rank-badge i {
      margin-right: 2px;
    }

    .rank-badge .hash {
      margin-left: 4px;
    }

    .typer-caret::after {
      content: "▮";
      margin-left: 4px;
      animation: blink 1.2s steps(1, end) infinite;
    }

    .nes-balloon[data-typer] {
      position: relative;
      display: inline-block;
    }

    .nes-balloon[data-typer] .typer {
      position: absolute;
      inset: 0;
      white-space: pre-wrap;
    }

    .nes-balloon[data-typer] .placeholder {
      visibility: hidden;
      white-space: pre-wrap;
    }

    .nes-table td.level {
      max-width: 200px;
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* 固定表格布局：避免因内容变化引起列宽跳动 */
    .leaderboard-table {
      table-layout: fixed;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      /* 如需多行换行，可改为 normal，并删掉 ellipsis */
    }

    /* Team 列如果想换行：取消 nowrap，并允许断词 */
    /* .leaderboard-table td.team { white-space: normal; overflow-wrap: break-word; } */

    /* 骨架占位（shimmer） */
    .skel {
      position: relative;
      height: 1em;
      border-radius: 4px;
      background: rgba(255, 255, 255, .08);
      overflow: hidden;
    }

    .skel::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg,
          transparent, rgba(255, 255, 255, .18), transparent);
      animation: shimmer 1.2s infinite;
    }

    @keyframes shimmer {
      100% {
        transform: translateX(100%);
      }
    }

    /* 让占位条在不同列宽里看起来舒适 */
    .skel.w-60 {
      width: 60%;
    }

    .skel.w-40 {
      width: 40%;
    }

    .skel.w-30 {
      width: 30%;
    }

    .skel.w-20 {
      width: 20%;
    }

    .skel.w-10 {
      width: 10%;
    }

    /* 错误行样式 */
    .tr-error td {
      color: #ff8a8a;
    }
  </style>
</head>

<body>
  <!--
    HOW TO CONFIGURE
    1) Set the competition start instant in CONFIG.startTime (ISO-8601).
       Example: "2025-09-05T10:00:00Z" (UTC) or "2025-09-05T12:00:00+02:00" (local with offset).
       You can also override via URL like: ?start=2025-09-05T10:00:00Z&repo=https://github.com/org/repo
    2) The competition duration is fixed to 5 hours by default (CONFIG.durationHours = 5).
    3) Update the leaderboard data below in the LEADERBOARD array.
  -->

  <div class="wrap">
    <header>
      <i class="nes-pokeball" aria-hidden="true"></i>
      <div>
        <h1 class="brand-title">Parallel Computing Leaderboard @uni.lu</h1>
      </div>
      <div class="repo-actions">
        <img src="https://i.imgur.com/6Y7QLfN.png" width="100px" />
      </div>
    </header>

    <section class="grid">
      <!-- Left column -->
      <!-- <div class="nes-container is-dark with-title hero">
        <p class="title">Status</p>

        <div class="status-line">
          <span id="statusBadge" class="nes-badge"><span class="is-warning">STARTS IN</span></span>
          <span id="statusLabel">Starts in</span>
          <span id="statusCountdown" class="countdown-time" aria-live="polite">--:--:--</span>
        </div>

        <progress id="statusProgress" class="nes-progress is-primary" value="0" max="100" hidden></progress>
      </div> -->
      <!-- Right column -->
      <div>
        <div class="nes-container is-dark with-title">
          <p class="title" id="ldb">Leaderboard</p>
          <table class="nes-table is-bordered is-dark leaderboard-table">
            <colgroup>
              <col style="width:20px"> <!-- Rank -->
              <col style="width:20px"> <!-- Team -->
              <col style="width:70px"> <!-- Level -->
              <col style="width:50px"> <!-- Score -->
            </colgroup>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Pokemon</th>
                <th>Runtime</th>
                <th>Last Submission</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody"></tbody>
          </table>
          <br />
          <!-- <p style="font-size: 12px;">!Participants are ranked by level first; if levels are equal, the shorter runtime
            prevails.</p> -->
        </div>
      </div>
    </section>
    <footer style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
      <span class="pill">Parallel Computing<a
          href="https://www.uni.lu/fstm-en/study-programs/master-in-high-performance-computing/"> @MHPC2025</a>, made
        with <a href="https://github.com/nostalgic-css/NES.css">NES.css</a> by @Multivac</span>
      <!-- <span class="pill">Made with NES.css</span> -->
    </footer>
  </div>

  <script>
    const OFFSET = 168;
    const BASE_ = '172.17.6';

    // ======== CONFIG ========
    const POLL_MS = 30000;
    const CONFIG = {
      title: 'Parallel Computing',
      startTime: '2025-09-11T06:00:00Z',
      lab: 'C++ Hello World Lab',
      durationHours: 5
    };

    // Allow runtime overrides via URL parameters
    const params = new URLSearchParams(location.search);
    if (params.get('lab')) CONFIG.lab = params.get('lab');
    document.getElementById('ldb').textContent = `Leaderboard - ${CONFIG.lab}`;

    let leaderboardData = []
    // ====== 模拟 API（保留/替换为真实 fetch 均可） ======
    function fetchLeaderboard() {
      return new Promise((resolve, reject) => {
        fetch(`https://telerun-results.huangweiurob.workers.dev/lab?lab=${encodeURIComponent(CONFIG.lab)}&limit=100`, { cache: 'no-store' })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            const leaderboardData = data.telerun
            const finalData = leaderboardData.map(dt => {
              return {
                // team: team.name,
                pokemon: dt.user,
                score: dt.runtime_ms,
                last: dt.ts,
              };
            });
            resolve(finalData);
          })
          .catch(() => reject(new Error('Network error')));
      });
    }

    // ====== 占位/错误渲染 ======
    function renderLoadingRows() {
      tbody.innerHTML = '';
      for (let i = 0; i < 7; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="skel w-20"></span></td>
          <td><span class="skel w-60"></span></td>
          <td><span class="skel w-30"></span></td>
          <td><span class="skel w-20"></span></td>
          <td><span class="skel w-40"></span></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderErrorRow(msg = `Failed to load. Retrying in ${POLL_MS / 1000}s…`) {
      tbody.innerHTML = '';
      const tr = document.createElement('tr');
      tr.className = 'tr-error';
      const td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = msg;
      tr.appendChild(td);
      tbody.appendChild(tr);
    }

    // ====== 排名渲染（并列同名次：1,2,2,4…） ======
    function renderLeaderboard(data) {
      const rows = [...data].sort((a, b) => {
        return a.score - b.score;
      });

      tbody.innerHTML = '';

      let displayRank = 0; // 当前显示名次
      let seenCount = 0; // 迭代到第几条
      let prevScore = null;
      let prevLevel = null;

      for (const row of rows) {
        seenCount++;
        if (row.score !== prevScore) {
          displayRank = seenCount; // 新分数段：名次=当前序号
          prevScore = row.score;
        }

        const tr = document.createElement('tr');
        const rankTd = document.createElement('td');
        const pokemonTd = document.createElement('td');
        const scoreTd = document.createElement('td');
        const lastTd = document.createElement('td');

        const rankWrap = document.createElement('span');
        let s = '';
        let icons = '';
        if (displayRank === 1) {
          icons = '<i class="nes-icon trophy" aria-hidden="true"></i>'.repeat(1);
        }
        // else if (displayRank === 2) icons = '<i class="nes-icon trophy" aria-hidden="true"></i>'.repeat(2);
        // else if (displayRank === 3) icons = '<i class="nes-icon trophy" aria-hidden="true"></i>';
        if (icons) rankWrap.innerHTML = icons + '<span class="hash">#' + displayRank + '</span>';
        else rankWrap.textContent = `#${displayRank}`;
        rankTd.appendChild(rankWrap);

        pokemonTd.className = 'pokemon';
        pokemonTd.textContent = row.pokemon;

        scoreTd.className = 'score';
        scoreTd.textContent = row.score.toLocaleString();
        scoreTd.textContent = row.score.toLocaleString();

        const lastDate = new Date(row.last);
        console.log(lastDate);
        lastTd.textContent = isNaN(lastDate) ? '-' : lastDate.toUTCString();

        tr.append(rankTd, pokemonTd, scoreTd, lastTd);
        tbody.appendChild(tr);
      }
    }
    // ======== DOM REFS ========
    const prelaunchEl = document.getElementById('prelaunch');
    const liveEl = document.getElementById('live');
    const endedEl = document.getElementById('ended');
    const countdownEl = document.getElementById('countdown');
    const progressEl = document.getElementById('progress');
    const tbody = document.getElementById('leaderboardBody');

    // ======== INIT ========
    document.title = CONFIG.title;

    const DURATION_MS = (CONFIG.durationHours || 5) * 60 * 60 * 1000;

    // Parse start time safely
    let startMs = Date.parse(CONFIG.startTime);
    if (Number.isNaN(startMs)) {
      // Fallback: start in 1 hour if invalid
      startMs = Date.now() + 60 * 60 * 1000;
    }
    const endMs = startMs + DURATION_MS;

    // Localized timestamps for display
    const startDate = new Date(startMs);
    const startLocal = startDate.toLocaleString(undefined, {
      year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit'
    });

    renderLeaderboard(leaderboardData);

    // assumes CONFIG.startTime and CONFIG.durationHours already exist

    const badgeInner = document.querySelector('#statusBadge > span');
    const statusLabel = document.getElementById('statusLabel');
    const statusCountdown = document.getElementById('statusCountdown');
    const statusProgress = document.getElementById('statusProgress');

    const fmt = (ms) => {
      const t = Math.max(0, Math.floor(ms / 1000));
      const h = String(Math.floor(t / 3600)).padStart(2, '0');
      const m = String(Math.floor((t % 3600) / 60)).padStart(2, '0');
      const s = String(t % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    };

    function fmtLong(ms) {
      if (ms < 0) ms = 0;
      const totalSec = Math.floor(ms / 1000);
      const days = Math.floor(totalSec / 86400);
      const hours = Math.floor((totalSec % 86400) / 3600);
      const minutes = Math.floor((totalSec % 3600) / 60);
      const seconds = totalSec % 60;

      const parts = [];
      const add = (v, label) => parts.push(`${v} ${label}${v === 1 ? "" : "s"}`);

      if (days) add(days, "day");
      if (days || hours) add(hours, "hour");
      if (days || hours || minutes) add(minutes, "minute");
      add(seconds, "second");

      return parts.join(" ");
    }

    function typeBalloon(el, { speed = 25, startDelay = 200, cursor = true } = {}) {
      const ps = Array.from(el.querySelectorAll('p'));
      const raw = (ps.length ? ps.map(p => p.textContent.trim()).join('\n\n')
        : el.textContent.trim());

      el.innerHTML = '';
      el.style.position = 'relative';

      const placeholder = document.createElement('div');
      placeholder.className = 'placeholder';
      placeholder.textContent = raw;

      const typer = document.createElement('div');
      typer.className = 'typer' + (cursor ? ' typer-caret' : '');

      const pad = getComputedStyle(el).padding;
      if (pad) typer.style.padding = pad;

      el.append(placeholder, typer);

      const esc = s => s.replace(/[&<>]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m]));

      let i = 0;
      function step() {
        if (i >= raw.length) {
          typer.classList.remove('typer-caret');
          return;
        }
        const ch = raw[i++];
        typer.innerHTML += (ch === '\n') ? '<br>' : esc(ch);
        setTimeout(step, speed);
      }
      setTimeout(step, startDelay);
    }

    function updateStatus() {
      const now = Date.now();

      if (now < startMs) {
        badgeInner.className = 'is-warning';
        badgeInner.textContent = 'STARTS IN';
        statusLabel.textContent = 'Starts in';
        statusCountdown.textContent = fmtLong(startMs - now);
        statusProgress.hidden = true;
      } else if (now < endMs) {
        // time left in competition
        badgeInner.className = 'is-success';
        badgeInner.textContent = 'TIME LEFT';
        statusLabel.textContent = 'Time left';
        const remaining = endMs - now;
        statusCountdown.textContent = fmt(remaining);
        statusProgress.hidden = false;
        statusProgress.value = ((now - startMs) / (endMs - startMs)) * 100;
      } else {
        // finished
        badgeInner.className = 'is-error';
        badgeInner.textContent = 'FINISHED';
        statusLabel.textContent = 'Finished';
        statusCountdown.textContent = '00:00:00';
        statusProgress.hidden = false;
        statusProgress.value = 100;
      }
    }


    document.querySelectorAll('.nes-balloon[data-typer]').forEach((el, idx) => {
      const speed = Number(el.getAttribute('data-typer-speed')) || 25;
      const delay = Number(el.getAttribute('data-typer-delay')) || (200 + idx * 200);
      typeBalloon(el, { speed, startDelay: delay, cursor: true });
    });
    // updateStatus();
    // setInterval(updateStatus, 1000);
    // ====== 刷新调度（首屏展示骨架、每30s轮询） ======
    const MIN_SKELETON_MS = 400; // 防止瞬间闪烁

    async function refreshLeaderboard() {
      // 展示骨架
      const t0 = performance.now();
      // renderLoadingRows();

      try {
        const data = await fetchLeaderboard();
        const elapsed = performance.now() - t0;
        // 保持最少骨架时间，避免闪烁
        if (elapsed < MIN_SKELETON_MS) {
          await new Promise(r => setTimeout(r, MIN_SKELETON_MS - elapsed));
        }
        renderLeaderboard(data);
      } catch (e) {
        console.error(e);
        renderErrorRow();
      }
    }

    // 首次拉取
    refreshLeaderboard();
    // 轮询
    // setInterval(refreshLeaderboard, POLL_MS);
  </script>
</body>

</html>